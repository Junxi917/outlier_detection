<div class="ui container">
    <div class="ui form">
        <form class="uploadForm" action="" method="post" enctype="multipart/form-data" name="frm">

            {% csrf_token %}
            <h3 class="ui header" id="dimension">Dimension</h3>
            <div class="field">
                <div class="fields">
                    <div class="eight wide field">
                        <select name="dim_select" id="DIM_select" class="ui fluid search dropdown">
                            <option value="Unit" selected>Unit Dimension</option>
                            <option value="Multi">Multi Dimension</option>
                        </select>
                    </div>

                </div>
            </div>


            <br>


            <label for="file" class="ui icon button">
                <i class="file icon"></i>
                Open File</label>
            <input type="file" id="file" name="myFile" style="display:none">

            {% if enable %}
                <input type="submit" name="upload" class="ui blue button" value="Submit" disabled/>

            {% else %}
                <input type="button" id="upload" class="ui blue button" onclick="FileUpload()" value="Submit"/>
                <script>
                    function FileUpload() {
                        {#$("#data_graph").hide();#}
                        $("#result_table").hide();
                        $("#graph1").hide();
                        $("#result_table1").hide();
                        $("#graph2").hide();
                        $("#result_table2").hide();
                        $("#graph3").hide();

                        $("#progressHTML").attr("class","ui blue progress");
                        $("#progressHTML1").attr("class","ui blue progress");

                        $("#progressHTML").progress({percent: 0});
                        $("#progressHTML").show();
                        $("#progressHTML1").progress({percent: 0});
                        $("#progressHTML1").show();
                        var form_data = new FormData();
                        var file_info = $('#file')[0].files[0];
                        var dim_select = $("#DIM_select").val();
                        var Val = $('#file').val();
                        if (dim_select != '') {
                            form_data.append('dim_select', dim_select);
                        }
                        if (Val != '') {
                            form_data.append('myFile', file_info);
                            form_data.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                            var dimmer = $("#dimmer");
                            dimmer.attr('class', 'ui dimmer');
                            $("#data_graph").show();
                            {#dimmer.children('div').remove();#}
                            {#dimmer.append('<div class="ui text loader">Loading……</div>');#}
                        }
                        {#$("#progressHTML").progress({percent: 50});#}
                        let percentValue = 0,
                            progressBar = $('#progressHTML');
                        progressBar1 = $('#progressHTML1');
                        timer = setInterval(startBar, 3000);
                        $.ajax({
                            url: '{% url 'upload' %}',
                            type: 'POST',
                            data: form_data,
                            processData: false,  // tell jquery not to process the data
                            contentType: false, // tell jquery not to set contentType
                            beforeSend: function () {
                                startBar();
                            },

                            success: function (ret) {
                                {#$("#progressHTML").progress({percent: 80});#}

                                $("#result_table").empty();
                                $("#result_table1").empty();
                                $("#result_table2").empty();
                                var chart_total_trend = echarts.init(document.getElementById('bar_total_trend'), 'white', {renderer: 'canvas'});
                                var chart_total_trend1 = echarts.init(document.getElementById('bar_total_trend1'), 'white', {renderer: 'canvas'});
                                var chart_total_trend2 = echarts.init(document.getElementById('bar_total_trend2'), 'white', {renderer: 'canvas'});
                                var chart_gap_filling_bar_total_trend = echarts.init(document.getElementById('gap_filling_bar_total_trend'), 'white', {renderer: 'canvas'});
                                var chart_gap_filling_bar_total_trend1 = echarts.init(document.getElementById('gap_filling_bar_total_trend1'), 'white', {renderer: 'canvas'});
                                var chart_gap_filling_bar_total_trend2 = echarts.init(document.getElementById('gap_filling_bar_total_trend2'), 'white', {renderer: 'canvas'});
                                chart_total_trend.clear();
                                chart_total_trend1.clear();
                                chart_total_trend2.clear();
                                chart_gap_filling_bar_total_trend.clear();
                                chart_gap_filling_bar_total_trend1.clear();
                                chart_gap_filling_bar_total_trend2.clear();

                                $("#ALGO_select option[value='Default']").remove();
                                $("#ALGO_select").append('<option value=' + "Default" + ' selected' + '>' + ret['default_algo'] + '</option>');

                                $("#result_table").html(ret['data']);
                                $(document).ready(function () {

                                    var table = $('#data').DataTable({
                                        buttons: ['copy', 'excel', 'pdf', 'colvis']
                                    });
                                    table.buttons().container()
                                        .appendTo($('div.eight.column:eq(0)', table.table().container()));
                                    dimmer.attr('class', 'ui dimmer');

                                    $("#result_table").show();
                                    $("#graph1").show();
                                    $("#progressHTML").progress({percent: 100});
                                    $("#progressHTML1").progress({percent: 100});
                                    clearInterval(timer);
                                    $("#progressHTML").hide();
                                    $("#progressHTML1").hide();

                                });

                                var chart = echarts.init(document.getElementById('bar_total_trend_original'), 'white', {renderer: 'canvas'});
                                chart.showLoading({
                                    text: 'Data Loading'
                                });

                                chart.clear();
                                chart.setOption(ret['bar_total_trend']);
                                chart.hideLoading()


                                {#$('#upload').attr("disabled", "disabled");#}
                                $('#AJAX_get').attr("disabled", false);
                                $('#Gap_filling').attr("disabled", false);


                            },
                            error: function (response) {
                                console.log('fail')
                                alert(response["responseJSON"]["error"]);

                                progressBar.attr("class","ui progress error");
                                progressBar.progress({percent: 100});
                                progressBar.append('<div class="label">There was an error.</div>');
                                progressBar1.attr("class","ui progress error");
                                progressBar1.progress({percent: 100});
                                progressBar1.append('<div class="label">There was an error.</div>');
                                clearInterval(timer);

                            }
                        })

                        function startBar() {
                            percentValue += 1;
                            if (percentValue > 75) percentValue = 75;
                            progressBar.progress({percent: percentValue});
                            progressBar1.progress({percent: percentValue});
                        }
                    }

                </script>


            {% endif %}


            <br><br><br>

            <h3 class="ui header" id="analysis">Algorithm</h3>
            <div class="field">
                <div class="fields">
                    <div class="eight wide field">
                        <select name="algo_select" id="ALGO_select" class="ui fluid search dropdown">
                            <option value="Forest">Isolation Forest</option>
                            <option value="Default" selected>Default</option>
                            <option value="Lstm">LSTM</option>
                            <option value="Hbos">HBOS</option>
                            <option value="Cblof">CBLOF</option>
                        </select>
                    </div>

                </div>
            </div>


            <div class="ui buttons">

                {#                <input class="ui blue button" type='button' id='AJAX_get' value="Anomaly Detection" disabled=""/>#}
                {% if enable %}
                    <input type="button" class="ui blue button" id='AJAX_get' value="Anomaly Detection"/>

                {% else %}
                    <input type="button" class="ui blue button" id='AJAX_get' value="Anomaly Detection" disabled/>

                {% endif %}
            </div>
            <script type="text/javascript">
                $("#AJAX_get").click(function (event) {
                    event.preventDefault();

                    var form_data = {
                        "ALGO_select": $("#ALGO_select").val(),
                    };

                    {#$("#data_graph").hide();#}
                    $("#result_table1").hide();
                    $("#graph2").hide();
                    $("#progressHTML2").progress({percent: 0});
                    $("#progressHTML2").show();
                    $("#progressHTML3").progress({percent: 0});
                    $("#progressHTML3").show();
                    let percentValue = 0,
                        progressBar2 = $('#progressHTML2');
                    progressBar3 = $('#progressHTML3');
                    timer = setInterval(startBar, 3000);

                    {#var dimmer = $("#dimmer");#}
                    {#dimmer.attr('class', 'ui active dimmer');#}
                    {#dimmer.children('div').remove();#}
                    {#dimmer.append('<div class="ui text loader">Loading……</div>');#}

                    $.ajax({
                        url: '{% url 'query' %}',

                        type: 'GET',

                        data: form_data,
                        beforeSend: function () {
                            startBar();
                        },

                        success: function (ret) {
                            $("#label_size_unit").html(form_data['ALGO_select']);
                            $('#AJAX_get').attr("disabled", "disabled");
                            $('#Gap_filling').attr("disabled", false);

                            $("#result_table1").html(ret['data']);
                            $(document).ready(function () {
                                var table = $('#data1').DataTable({
                                    buttons: ['copy', 'excel', 'pdf', 'colvis']
                                });

                                table.buttons().container()
                                    .appendTo($('div.eight.column:eq(0)', table.table().container()));


                                $("#result_table1").show();
                                $("#progressHTML2").progress({percent: 100});
                                clearInterval(timer);
                                $("#graph2").show();
                                $("#progressHTML3").progress({percent: 100});
                                $("#progressHTML2").hide();
                                $("#progressHTML3").hide();

                                {#dimmer.attr('class', 'ui dimmer');#}

                            });


                            var chart = echarts.init(document.getElementById('bar_total_trend'), 'white', {renderer: 'canvas'});
                            chart.showLoading({
                                text: 'Data Loading'
                            });

                            chart.clear();
                            chart.setOption(ret['bar_total_trend']);
                            chart.hideLoading()

                            var chart1 = echarts.init(document.getElementById('bar_total_trend1'), 'white', {renderer: 'canvas'});
                            chart1.showLoading({
                                text: 'Data Loading'
                            });

                            chart1.clear();
                            chart1.setOption(ret['bar_total_trend1']);
                            chart1.hideLoading()

                            var chart2 = echarts.init(document.getElementById('bar_total_trend2'), 'white', {renderer: 'canvas'});
                            chart2.showLoading({
                                text: 'Data Loading'
                            });

                            chart2.clear();
                            chart2.setOption(ret['bar_total_trend2']);
                            chart2.hideLoading()

                            {#$("#data_graph").show();#}


                        },
                        error: function (response) {
                            console.log('fail')
                            alert(response["responseJSON"]["error"]);
                            dimmer.children('div').text('An error occurred');
                        }
                    })

                    function startBar() {
                        percentValue += 1;
                        if (percentValue > 75) percentValue = 75;
                        progressBar2.progress({percent: percentValue});
                        progressBar3.progress({percent: percentValue});
                    }
                })
            </script>

            <br><br><br>

            <h3 class="ui header" id="analysis">Filling Algorithm</h3>
            <div class="field">
                <div class="fields">
                    <div class="eight wide field">
                        <select name="filling_select" id="Filling_select" class="ui fluid search dropdown">
                            <option value="Interpolate" selected>Interpolate</option>
                            <option value="Mean">Mean</option>
                            <option value="Median">Median</option>
                        </select>
                    </div>

                </div>
            </div>

            <div class="ui buttons">
                <input class="ui blue button" type='button' id='Gap_filling' value="Gap Filling" disabled=""/>
            </div>
            <script type="text/javascript">
                $("#Gap_filling").click(function (event) {
                        event.preventDefault();

                        var form_data = {
                            "Gap_filling": $("#Filling_select").val(),
                        };

                        {#$("#data_graph").hide();#}
                        $("#result_table2").hide();
                        $("#graph3").hide();
                        $("#progressHTML4").progress({percent: 0});
                        $("#progressHTML4").show();
                        $("#progressHTML5").progress({percent: 0});
                        $("#progressHTML5").show();
                        let percentValue = 0,
                            progressBar4 = $('#progressHTML4');
                        progressBar5 = $('#progressHTML5');
                        timer = setInterval(startBar, 3000);

                        {#var dimmer = $("#dimmer");#}
                        {#dimmer.attr('class', 'ui active dimmer');#}
                        {#dimmer.children('div').remove();#}
                        {#dimmer.append('<div class="ui text loader">Loading……</div>');#}

                        $.ajax({
                            url: '{% url 'query' %}',

                            type: 'GET',

                            data: form_data,
                            beforeSend: function () {
                                startBar();
                            },

                            success: function (ret) {
                                $('#Gap_filling').attr("disabled", "disabled");
                                $('#AJAX_get').attr("disabled", false);

                                $("#result_table2").html(ret['data']);
                                $(document).ready(function () {
                                    var table = $('#data2').DataTable({
                                        buttons: ['copy', 'excel', 'pdf', 'colvis']
                                    });

                                    table.buttons().container()
                                        .appendTo($('div.eight.column:eq(0)', table.table().container()));


                                    $("#result_table2").show();
                                    $("#progressHTML4").progress({percent: 100});
                                    clearInterval(timer);
                                    $("#graph3").show();
                                    $("#progressHTML5").progress({percent: 100});
                                    $("#progressHTML4").hide();
                                    $("#progressHTML5").hide();

                                });

                                var chart = echarts.init(document.getElementById('gap_filling_bar_total_trend'), 'white', {renderer: 'canvas'});
                                chart.showLoading({
                                    text: 'Data Loading'
                                });

                                chart.clear();
                                chart.setOption(ret['bar_total_trend']);
                                chart.hideLoading()

                                var chart1 = echarts.init(document.getElementById('gap_filling_bar_total_trend1'), 'white', {renderer: 'canvas'});
                                chart1.showLoading({
                                    text: 'Data Loading'
                                });

                                chart1.clear();
                                chart1.setOption(ret['bar_total_trend1']);
                                chart1.hideLoading()

                                var chart2 = echarts.init(document.getElementById('gap_filling_bar_total_trend2'), 'white', {renderer: 'canvas'});
                                chart2.showLoading({
                                    text: 'Data Loading'
                                });

                                chart2.clear();
                                chart2.setOption(ret['bar_total_trend2']);
                                chart2.hideLoading()

                                {#$("#data_graph").show();#}


                            },
                            error: function () {
                                console.log('fail')
                            }
                        })

                        function startBar() {
                            percentValue += 1;
                            if (percentValue > 75) percentValue = 75;
                            progressBar4.progress({percent: percentValue});
                            progressBar5.progress({percent: percentValue});
                        }
                    }
                )
            </script>


        </form>
    </div>
</div>

<script>
    function initTable(table) {
        table.DataTable(
            {}
        );
    }
</script>

<script>
    function getForm() {
        var form_data = {
            "Load_data": 'Load_data',
        };

        return form_data
    }
</script>


<script>
    $('.ui.fluid.search.dropdown')
        .dropdown({fullTextSearch: true});
</script>
